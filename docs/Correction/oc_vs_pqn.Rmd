---
title: "Removing External Variability from GC-IMS Data: Linear Orthogonalization Approach"
author: "Tecla Duran Fort"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: yes
  pdf_document:
    toc: yes
    fig_caption: yes
  html_document:
    toc: yes
    df_print: paged
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.path = "orthogonal_correction_files/figure-latex/")
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(lubridate)
library(reshape2)
source("../../load_gcims_tools.R")
```

Load Peak Table

```{r load-data}
df <- read.csv("../../data/peak_table_var.csv")
```


# PQN Normalisation 

The **Probabilistic Quotient Normalization (PQN)** corrects for dilution or total intensity differences between samples.
For each sample:

1. The quotient between its spectrum and the reference spectrum is computed.
2. The **median of the quotients** gives the normalization factor *f*.
3. All intensities in that sample are divided by *f*.

```{r}
# Identify all columns corresponding to clusters
cluster_cols <- grep("^Cluster", names(df), value = TRUE)
```

A reference spectrum is required for PQN normalization, it will be computed as the median spectrum across all samples.


```{r}
# Compute the reference (median) spectrum using all the sa,ples
ref_spectrum <- df %>%
  select(starts_with("Cluster")) %>%
  summarise(across(everything(), median, na.rm = TRUE)) %>%
  as.numeric()

# Assign column names to the numeric vector for later reference
names(ref_spectrum) <- colnames(
  df %>%
    select(starts_with("Cluster"))
)
```


```{r}
df_pqn <- df %>%
  mutate(across(starts_with("Cluster"), as.numeric)) %>%
  group_split(row_number()) %>%                     # Split into individual samples
  map_dfr(function(row_df) {
    # Extract numeric cluster values for the current sample
    x <- as.numeric(row_df %>%
                      select(starts_with("Cluster")) %>%
                      select(-any_of(excluded_names)))
    
    # Compute the ratio between sample and reference spectrum
    quotients <- x / ref_spectrum
    quotients <- quotients[is.finite(quotients)]    # Remove non-finite values
    
    # Median of quotients = normalization factor
    f <- median(quotients, na.rm = TRUE)
    
    # Apply normalization and store the factor
    row_df %>%
      mutate(across(starts_with("Cluster"), ~ .x / f),
             PQN_factor = f)
  })
```


# Orthogonal Correction

```{r apply-correction}
intensities <- df %>% dplyr::select(starts_with("Cluster"))

# Correction for both elapsed time and batch
corrected_intensities <- orthogonal_correction(
  intensities, 
  df %>% dplyr::select(elapsed_time, batch)
)

# Extract corrected data and projection
intensities_final <- corrected_intensities$corrected
projection_both <- corrected_intensities$projection
```


# Comparison

## Relative Standard Deviation (RSD)

```{r rsd-comparison, echo=FALSE}
rsd_raw <- sapply(intensities, function(x) sd(x) / mean(x) * 100)
rsd_corr <- sapply(intensities_final, function(x) sd(x) / mean(x) * 100)
rsd_pqn <- sapply(df_pqn, function(x) sd(x) / mean(x) * 100)

rsd_df <- data.frame(Cluster = names(rsd_raw),
                     Raw = rsd_raw,
                     Corrected = rsd_corr)

rsd_melt <- rsd_df %>% pivot_longer(-Cluster, names_to = "Condition", values_to = "RSD")

ggplot(rsd_melt, aes(x = RSD, fill = Condition)) +
  geom_histogram(position = "identity", binwidth = 5, alpha = 0.6) +
  scale_fill_manual(values = c("#1D3557", "#A8DADC")) +
  labs(title = "RSD Distribution Before and After Correction",
       x = "Relative Standard Deviation (%)",
       y = "Number of Clusters") +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

